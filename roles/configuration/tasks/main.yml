###############################################################################
# Configure Arch Linux
###############################################################################
---

- name: Set the time zone
  shell: arch-chroot /mnt ln -sf "/usr/share/zoneinfo/{{ zone }}" /etc/localtime
  tags: zone

- name: Configure the hardware clock
  shell: arch-chroot /mnt hwclock --systohc
  tags: clock

- name: Set the locale
  replace:
    path: /mnt/etc/locale.gen
    regexp: "^#(en_US.UTF-8.*)"
    replace: '\1'
  tags: locale

- name: Generate the locale
  shell: arch-chroot /mnt locale-gen
  tags: locale

- name: Create the locale conf file
  copy:
    dest: /mnt/etc/locale.conf
    content: "LANG=en_US.UTF-8\n"
    force: no
  tags:
    - locale
    - localeconf

- name: Create the hostname file
  copy:
    dest: /mnt/etc/hostname
    content: "{{ hostname }}\n"
    force: no
  tags:
    - hostname

- name: Add this host the hosts file
  blockinfile:
    path: /mnt/etc/hosts
    block: |
      127.0.0.1  localhost
      ::1        localhost
      127.0.1.1  {{ hostname }}.localdomain  {{ hostname }}
  tags:
    - hostname

- name: Modify the mkinitcpio.conf HOOKS to add encrypt
  replace:
    path: /mnt/etc/mkinitcpio.conf
    regexp: '^(HOOKS.*block)( filesystems.*)$'
    replace: '\1 encrypt\2'
  tags: initramfs
